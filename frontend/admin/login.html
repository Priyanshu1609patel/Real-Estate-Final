<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Real Estate Admin</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header style="background:linear-gradient(135deg, #1a237e 0%, #3949ab 100%);color:#fff;padding:1.2rem 2.5rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(26,35,126,0.15);">
    <div class="site-title" style="font-size:1.6rem;font-weight:800;letter-spacing:1.2px;text-shadow:0 2px 4px rgba(0,0,0,0.1);">Real Estate Admin</div>
    <a href="../public/home_page.html" class="home-btn" style="background:#fff;color:#1a237e;padding:0.7rem 1.5rem;border-radius:12px;font-weight:700;text-decoration:none;box-shadow:0 4px 12px rgba(26,35,126,0.12);transition:all 0.3s ease;display:flex;align-items:center;gap:8px;"><i class="fas fa-home" style="font-size:0.9rem;"></i>Home Page</a>
  </header>
  <main class="auth-main">
    <div class="auth-card">
      <h2>Welcome Back</h2>
      <form class="auth-form" id="login-form">
        <div>
          <label for="login-username">Username or Email</label>
          <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="login-username" name="login-username" required autocomplete="username" placeholder="Enter your username or email">
          </div>
        </div>
        <div>
          <label for="login-password">Password</label>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="login-password" name="login-password" required autocomplete="current-password" placeholder="Enter your password">
          </div>
        </div>
        <button type="submit">Sign In <i class="fas fa-arrow-right" style="margin-left:8px;"></i></button>
      </form>
      <p class="auth-switch">Don't have an account? <a href="register.html">Register Now</a></p>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loginForm = document.getElementById('login-form');
      let submitBtn;
      let originalBtnText;

      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const username = formData.get('login-username');
        const password = formData.get('login-password');
        
        if (!username || !password) {
          alert('Please fill in all fields!');
          return;
        }
        
        try {
          // Show loading state
          submitBtn = e.target.querySelector('button[type="submit"]');
          originalBtnText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
          
          // Try both production and local endpoints
          const endpoints = [
            'https://real-estate-app-20a2.onrender.com/api/users/login',
            'http://localhost:3001/api/users/login'
          ];
          
          let lastError = null;
          let lastResponse = null;
          
          for (const endpoint of endpoints) {
            try {
              console.log('Trying endpoint:', endpoint);
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  username: username,
                  password: password,
                  email: username // Try with email as well
                })
              });
              
              lastResponse = response;
              const data = await response.json().catch(() => ({}));
              
              if (response.ok) {
                // Store user data in localStorage for session management
                if (data.user || data.message === 'Login successful') {
                  localStorage.setItem('user', JSON.stringify(data.user || { username }));
                  localStorage.setItem('isLoggedIn', 'true');
                  
                  if (data.token) {
                    localStorage.setItem('token', data.token);
                  }
                  
                  console.log('Login successful, redirecting...');
                  window.location.href = 'index.html';
                  return;
                }
              } else {
                lastError = data.error || response.statusText || 'Login failed';
                console.error('Login error from', endpoint, ':', lastError, 'Status:', response.status);
              }
            } catch (err) {
              console.error('Error with endpoint', endpoint, ':', err);
              lastError = 'Connection error. Please try again.';
            }
          }
          
          // If we get here, all endpoints failed
          const errorMessage = lastResponse ? 
            `Login failed: ${lastError || 'Invalid response from server'}` : 
            'Failed to connect to the server. Please check your internet connection.';
          
          throw new Error(errorMessage);
          
        } catch (error) {
          console.error('Login error:', error);
          alert(error.message || 'Login failed! Please check your credentials and try again.');
        } finally {
          // Reset button state
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText || 'Sign In <i class="fas fa-arrow-right" style="margin-left:8px;"></i>';
          }
        }
      });
    });
  </script>
</body>
</html>